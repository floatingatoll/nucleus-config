stages:
  - deploy

.deploy-aws:
  stage: deploy
  tags:
    - aws
    - mozmeao
  script:
    - kubectl apply -f ${DEPLOYMENT}
    - ./rollout-status.sh ${DEPLOYMENT}

deploy frankfurt dev:
  extends: .deploy-aws
  variables:
    DEPLOYMENT: mozmeao-fr/nucleus-dev
    KUBECONFIG: /home/gitlab-runner/.kube/mozmeao-fr-1.kubeconfig
  only:
    changes:
      - mozmeao-fr/nucleus-dev/*
    refs:
      - master

deploy frankfurt stage:
  extends: .deploy-aws
  variables:
    DEPLOYMENT: mozmeao-fr/nucleus-stage
    KUBECONFIG: /home/gitlab-runner/.kube/mozmeao-fr-1.kubeconfig
  only:
    changes:
      - mozmeao-fr/nucleus-stage/*
    refs:
      - master

deploy frankfurt prod:
  extends: .deploy-aws
  variables:
    DEPLOYMENT: mozmeao-fr/nucleus-prod
    KUBECONFIG: /home/gitlab-runner/.kube/mozmeao-fr-1.kubeconfig
  only:
    changes:
      - mozmeao-fr/nucleus-prod/*
    refs:
      - master
